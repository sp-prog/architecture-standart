### <a name="_b7urdng99y53"></a>**Название задачи:** ADR-2. Концептуальная архитектура передачи ставок в call-центры для MVP
 
### <a name="_hjk0fkfyohdk"></a>**Автор:** 
### <a name="_uanumrh8zrui"></a>**Дата:** 
### <a name="_3bfxc9a45514"></a>**Функциональные требования**

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| :-: | :- | :- | :- |
| FT-6   | Сотрудник call-центра банка | Просматривает список ставок | 1. Сотрудник входит в систему call-центра под своей учетной запись; 2. Сотрудник просамтривает список ставок, доступный клиенту |
| FT-7   | Сотрудник партнерского call-центра | Просматривает список ставок | 1. Сотрудник входит в систему партнгерского call-центра под своей учетной запись; 2. Сотрудник просамтривает список ставок, доступный клиенту |


### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**
|**№**|**Требование**|
| :-: | :- |
|NFT-19. |Партнерский call-центр может работать только с файлами по SFTP|
|NFT-20. |SFTP должен быть защищен от доступа посторонних лиц|
|NFT-21. |При передаче файлов необходимо использовать шифрование|
|NFT-22. |Для большей защиты данных файлы можно упаковывать в архив с паролем, который будет менятся через задынный промежуток времени|
|NFT-23. |Необходима проверка решения в отделе ИТ безопасности банка|
|NFT-24. |Т.к. это партнерский call-центр, то у него уже должен быть в каком-то виде организован доступ к персональным данным клиентов банка. Поэтому в файла персональных скидок не должны содержаться персональные данные. Их необходимо заменить на какие-либо идентификаторы, по которым клиентов можно найти внутри данных call-центра|

### <a name="_qmphm5d6rvi3"></a>**Решение**


## Диаграмма контекстов

```plantuml

@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

LAYOUT_WITH_LEGEND()

title Диаграмма контекстов банка Стандарт

Person_Ext(partner_employee, "Сотрудник партнерского call-центра")
System_Ext(partner_call_center, "Партнерский call-центр")

Enterprise_Boundary(c0, "Банк Стандарт") {
    Person(employee, "Сотрудник call-центра банка")
    System(call_center, "Call-центр банка")
    System(abs, "Автоматизированная банковская система (АБС)")
}

Rel(employee, call_center, "1. Просматривает доступные клиенту ставки")

Rel(abs, call_center, "2. Отправляет call-центру банка ставки")
Rel(abs, partner_call_center, "3. Отправляет партнерскому call-центру ставки")

Rel(partner_employee, partner_call_center, "4. Просматривает доступные клиенту ставки")

@enduml

```

## Схема контейнеров

```plantuml

@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml?a

title Диаграмма контейнеров банка Стандарт

Boundary(b0, "Партнер банка") {
    Person_Ext(partner_employee, "Сотрудник партнерского call-центра")
    System_Ext(partner_call_center, "Партнерский call-центр")
}

Boundary(b1, "Банк Стандарт") {
    Container(abs, "Автоматизированная банковская система (АБС)")
    Container(ad, "Система контроля доступа сотрудников стороннего call-центра")
    Container(sftp, "Файловый sftp-сервер")
    Container(partner_call_center_bg, "Вспомогательный сервис партнерского call-центра")

    Boundary(b2, "Call-центр банка") {
        Person(employee, "Сотрудник call-центра банка")
        Container(call_center, "Call-центр банка")
        Container(call_center_bg, "Вспомогательный сервис call-центр банка")
        ContainerDb(call_center_db, "БД call-центр банка")
    }

    Boundary(b3, "Kafka") {
        ContainerQueue(queue_deposits, "Канал обмена ставками на депозиты")
    }
}

Rel(employee, call_center, "1.1 Запрос ставок", "https")
Rel(call_center, call_center_db, "1.2 Запрос ставок", "TLS")

Rel(abs, queue_deposits, "2.1. Отправка ставок подписчикам", "TLS")
Rel(queue_deposits, partner_call_center_bg, "2.2.1 Получение ставок", "TLS")
Rel(partner_call_center_bg, sftp, "2.2.2 Формирование файла и размещение его в файловом хранилище", "TLS")
Rel(queue_deposits, call_center_bg, "2.3.1 Получение ставок", "TLS")
Rel(call_center_bg, call_center_db, "2.3.2 Запись ставок", "TLS")

Rel(partner_employee, partner_call_center, "3.1. Запрос ставок", "https")
Rel(partner_call_center, sftp, "3.2 Поиск самого свежего файла со ставками", "TLS")
Rel(sftp, ad, "3.3 Проверка прав доступа", "TLS")

SHOW_LEGEND()
@enduml

```

#### Шифрование
См. ADR-1.

#### Вспомогательный сервис
Kafka используется в связи с принятым решением в ADR-1.

Общая предметная область в БД позволяет быстро с учетом требования к масштабируемости без создания зависимостей между сервисами интернет-банка рабоать с необходимыми обоим сервисам данными. 

### <a name="_bjrr7veeh80c"></a>**Альтернативы**
По шифрованию см. ADR-1.

Решение по выдлению общей предметной области call-центра принято по следующим причинам:
- для сохранения единообразия с решением 1
- для уменьшения количества изменений, которые необходимо внести в сервис call-центра
- для возможности независимого масштабирования сервисов call-центра при уееличении нагрузки
- для исключения нагрузок на сервис call-центра, связанных с обработкой очереди ставок

Работа с sftp выделена в отдельный сервис, т.к. этот функционал не требуется в call-центре банка, а работа с файлами обычно требовательна к ресурсам. Это может приводит к временной неработоспособности вспомогательного сервиса или к повышенным требованиям к количеству ресурсов при масштабировании

**Недостатки, ограничения, риски**

По файлам: файлы в момент чтения могут быть сформированы не полностью. SFTP сложно управлять и встраивать в него контроль доступа. Так же файлы обычно формируются дольше, чем записи в БД. Это приведет к задержкам обновления информации на стороне партнера

По общей предметной области см. ADR-1.


